let serverUrl="";function sleep(e){for(var r=new Date,s=r.getTime()+e;;)if((r=new Date).getTime()>s)return}function createRandom(e,r){return Math.floor(Math.random()*(r-e)+e)}function sendBackgroundMsg(e,r,s){if(e){var t={operation:e,msg:"通知："+r};s&&(t=Object.assign(t,s)),postMessage(t)}}var resourcePageCrawlerResult={operation:"resourcePageCrawlerResult",status:""};function pickupResource(e){try{var r=e.initUrl,s=e.code,t=e.time,a=e.fileName,o=e.url,u=e.scripts;if(!serverUrl)return resourcePageCrawlerResult.status="serverUrlNull",void postMessage(resourcePageCrawlerResult);if(!u||!o||!a)return resourcePageCrawlerResult.status="datatError",void postMessage(resourcePageCrawlerResult);if(!s&&r||s&&!r)return resourcePageCrawlerResult.status="datatError",void postMessage(resourcePageCrawlerResult);var l=(new Date).getTime();if(0!=Number(t)&&l-Number(t)>3e3)return resourcePageCrawlerResult.status="overtime",void postMessage(resourcePageCrawlerResult);let i=new XMLHttpRequest;i.open("POST",serverUrl+"/browser/js/v2_resource_page_chrome",!1),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var n="fileName="+a+"&url="+o+"&code="+s+"&scripts="+u+"&initUrl="+r;i.send(n);let c=i.status;if("200"==c||200==c){let e=i.responseText,r=JSON.parse(e),s=r.status,t=r.listMap;if("success"==s){t.listUrls.length>0?(getResourceList(t),sendBackgroundMsg("notification","This request is complete."),resourcePageCrawlerResult.status="end-1",postMessage(resourcePageCrawlerResult)):(resourcePageCrawlerResult.status="end-2",postMessage(resourcePageCrawlerResult))}else resourcePageCrawlerResult.status="serverBackError",postMessage(resourcePageCrawlerResult)}else resourcePageCrawlerResult.status="requestDisabled",postMessage(resourcePageCrawlerResult)}catch(e){resourcePageCrawlerResult.status="jsError",postMessage(resourcePageCrawlerResult),sendBackgroundMsg("notification","request resource page js error："+e)}}function getResourceList(e){try{if(e&&serverUrl){let r=e.shortUrl,s=e.listUrls,t=e.uk,a=e.shareid,o=e.bdstoken,u="";if(r&&s&&t&&a)for(let l=0;l<s.length;l++){u=s[l];let n=new XMLHttpRequest;n.open("GET",u,!1),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(null);let i=n.status;if("200"==i||200==i){let s=n.responseText,u=new XMLHttpRequest;u.open("POST",serverUrl+"/browser/json/v2_resource_list",!1),u.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),u.send("json="+encodeURIComponent(s)+"&shortUrl="+r+"&uk="+t+"&shareId="+a+"&bdstoken="+o);let l=u.status;if("200"==l||200==l){let r=u.responseText,s=JSON.parse(r);if("success"==s.status){let r=s.listUrls;r.length>0&&(e.listUrls=r,getResourceList(e))}}}}}}catch(e){sendBackgroundMsg("notification","get resource document list js error："+e)}}addEventListener("message",function(e){var r=e.data;if("run-source-page-crawler"==r.operation){var s=r.resourceData;serverUrl=s.serverUrl,pickupResource(s)}},!1);